var decoder={m_src:null,m_src_offset:0,m_dst:null,m_dst_offset:0,m_size:0,m_bits:0,m_crc:0,readWord:function(a,c){var b=a.charCodeAt(c)<<24,b=b|a.charCodeAt(c+1)<<16,b=b|a.charCodeAt(c+2)<<8;return b|=a.charCodeAt(c+3)},nextBit:function(){var a=this.m_bits&1;this.m_bits>>>=1;0==this.m_bits&&(this.m_bits=this.readWord(this.m_src,this.m_src_offset),this.m_src_offset-=4,this.m_crc^=this.m_bits,a=this.m_bits&1,this.m_bits=-2147483648|this.m_bits>>>1);return a},readBits:function(a){for(var c=0,b=0;b<a;b+=
1)c|=this.nextBit()<<a-1-b;return c},copyLiteral:function(a,c){for(var b=this.readBits(a)+c+1,d=0;d<b;d+=1)this.m_dst[this.m_dst_offset]=this.readBits(8),--this.m_dst_offset;this.m_size-=b},copyReference:function(a,c){for(var b=this.readBits(a),d=0;d<c;d+=1)this.m_dst[this.m_dst_offset]=this.m_dst[this.m_dst_offset+b],--this.m_dst_offset;this.m_size-=c},decode:function(a){this.m_src=a;this.m_src_offset=a.length-4;this.m_size=this.readWord(this.m_src,this.m_src_offset);this.m_src_offset-=4;this.m_crc=
this.readWord(this.m_src,this.m_src_offset);this.m_src_offset-=4;this.m_bits=this.readWord(this.m_src,this.m_src_offset);this.m_src_offset-=4;this.m_crc^=this.m_bits;this.m_dst=Array(this.m_size);for(this.m_dst_offset=this.m_size-1;0<this.m_size;)if(this.nextBit())switch(this.readBits(2)){case 3:this.copyLiteral(8,8);break;case 2:this.copyReference(12,this.readBits(8)+1);break;case 1:this.copyReference(10,4);break;case 0:this.copyReference(9,3)}else this.nextBit()?this.copyReference(8,2):this.copyLiteral(3,
0);console.assert(0==this.m_crc);return this.m_dst}},player_cmp={m_pos:0,m_playing:!1,m_yield:0,m_clear:0,m_palette:Array(32),m_scale:2,m_primitives:[],m_savedPrimitives:[],m_fixUpPalette:0,init:function(a){this.m_canvas=document.getElementById(a)},start:function(a){this.m_pos=this.readOffset(a);this.m_playing=!0;this.setDefaultPalette();this.m_timer=setInterval(function(){player_cmp.doTick()},15)},stop:function(){this.m_playing=!1;this.m_timer&&(clearInterval(this.m_timer),this.m_timer=null)},readOffset:function(a){0!=
a&&(a=this.readWord(this.m_cmd,2*(a+1)));return 2*(this.readWord(this.m_cmd,0)+1)+a},readByte:function(a,c){return a[c]},readWord:function(a,c){return 256*a[c]+a[c+1]},readNextByte:function(){var a=this.readByte(this.m_cmd,this.m_pos);this.m_pos+=1;return a},readNextWord:function(){var a=this.readWord(this.m_cmd,this.m_pos);this.m_pos+=2;return a},toSignedByte:function(a){return a-((a&128)<<1)},toSignedWord:function(a){return a-((a&32768)<<1)},doTick:function(){if(this.m_playing)if(0!=this.m_yield)--this.m_yield;
else for(;0==this.m_yield;){var a=this.readNextByte();if(a&128){this.m_playing=!1;break}switch(a>>2){case 0:case 5:case 9:this.updateScreen();break;case 1:this.m_clear=this.readNextByte();this.clearScreen();break;case 2:this.m_yield=4*this.readNextByte();break;case 3:var a=this.readNextWord(),c=0,b=0;a&32768&&(a&=32767,c=this.toSignedWord(this.readNextWord()),b=this.toSignedWord(this.readNextWord()));this.drawShape(a,c,b);break;case 4:a=this.readNextByte();c=this.readNextByte();this.setPalette(a,
c);break;case 6:a=this.readNextWord();break;case 7:break;case 8:this.m_pos+=3;break;case 10:a=this.readNextWord();b=c=0;a&32768&&(a&=32767,c=this.toSignedWord(this.readNextWord()),b=this.toSignedWord(this.readNextWord()));var d=512+this.toSignedWord(this.readNextWord()),e=this.readNextByte(),f=this.readNextByte();this.drawShapeScale(a,c,b,d,e,f);break;case 11:a=this.readNextWord();b=c=0;a&32768&&(a&=32767,c=this.toSignedWord(this.readNextWord()),b=this.toSignedWord(this.readNextWord()));d=512;a&16384&&
(a&=16383,d+=this.toSignedWord(this.readNextWord()));var e=this.readNextByte(),f=this.readNextByte(),k=this.readNextWord(),h=90;a&8192&&(a&=8191,h=this.readNextWord());var g=180;a&4096&&(a&=4095,g=this.readNextWord());this.drawShapeScaleRotate(a,c,b,d,e,f,k,h,g);break;case 12:this.m_yield=10;break;case 13:a=this.readNextWord();65535!=a&&(this.readNextByte(),this.readNextByte());break;default:console.log("Invalid opcode="+a),this.m_playing=!1}}},updateScreen:function(){var a=this.m_canvas.getContext("2d");
a.fillStyle="#000";a.fillRect(0,0,this.m_canvas.width,this.m_canvas.height);for(var c=0;c<this.m_primitives.length;c++){var b=this.m_primitives[c];a.globalAlpha=b.alpha?.8:1;this.drawPrimitive(a,b.x,b.y,b.dx,b.dy,b.num,b.color,b.transform);a.globalAlpha=1}this.flipScreen();this.m_yield=5},clearScreen:function(){0!=this.m_clear&&this.flipScreen()},drawShape:function(a,c,b,d){var e=this.readWord(this.m_pol,2);a=this.readWord(this.m_pol,e+2*a);e=this.readWord(this.m_pol,14);e+=a;a=this.readWord(this.m_pol,
e);for(var e=e+2,f,k,h=0;h<a;++h){var g=this.readWord(this.m_pol,e),e=e+2;g&32768?(f=this.toSignedWord(this.readWord(this.m_pol,e)),e+=2,k=this.toSignedWord(this.readWord(this.m_pol,e)),e+=2):k=f=0;var m=0!=(g&16384),l=this.readByte(this.m_pol,e);e++;0==this.m_clear&&(l+=16);this.queuePrimitive(c,b,f,k,g&16383,l,m,d)}0!=this.m_clear&&this.savePrimitives()},drawShapeScale:function(a,c,b,d,e,f){this.drawShape(a,c,b,{z:d,ix:e,iy:f})},drawShapeScaleRotate:function(a,c,b,d,e,f,k,h,g){this.drawShape(a,
c,b,{z:d,ix:e,iy:f,r1:k,r2:h,r3:g})},setDefaultPalette:function(){for(var a=0;16>a;a++){var c="#"+a.toString(16)+a.toString(16)+a.toString(16);this.m_palette[16+a]=this.m_palette[a]=c}this.m_fixUpPalette=0},setTaxiPalette:function(){for(var a="000 fff 000 886 664 444 aa8 684 ec0 ea0 c60 a40 620 66c 44a e86".split(" "),c=0;16>c;++c)this.m_palette[16+c]="#"+a[c];this.m_fixUpPalette=1},setPalette:function(a,c){var b=this.readWord(this.m_pol,6),b=b+32*a,d=0;if(0==c){if(0!=this.m_fixUpPalette)return;d=
16}for(var e=0;16>e;e++){var f=this.readWord(this.m_pol,b),b=b+2,k=f>>4&15,h=f&15;this.m_palette[d]="#"+(f>>8&15).toString(16)+k.toString(16)+h.toString(16);++d}},flipScreen:function(){0!=this.m_clear?this.clearPrimitives():this.restorePrimitives()},queuePrimitive:function(a,c,b,d,e,f,k,h){this.m_primitives.push({x:a,y:c,dx:b,dy:d,num:e,color:f,alpha:k,transform:h})},clearPrimitives:function(){this.m_primitives=[]},restorePrimitives:function(){this.m_primitives=this.m_savedPrimitives.slice()},savePrimitives:function(){this.m_savedPrimitives=
this.m_primitives.slice()},drawPrimitive:function(a,c,b,d,e,f,k,h){var g=this.readWord(this.m_pol,10);f=this.readWord(this.m_pol,g+2*f);g=this.readWord(this.m_pol,18);g+=f;f=this.readByte(this.m_pol,g);g++;var m=this.m_scale;a.fillStyle=a.strokeStyle=this.m_palette[k];a.save();a.scale(m,m);k=this.toSignedWord(this.readWord(this.m_pol,g));var g=g+2,l=this.toSignedWord(this.readWord(this.m_pol,g)),g=g+2;h&&(a.translate(h.ix,h.iy),a.scale(h.z/512,h.z/512),k-=h.ix,l-=h.iy);c+=k+d;b+=l+e;if(f&128)a.translate(c,
b),c=this.toSignedWord(this.readWord(this.m_pol,g)),g=this.toSignedWord(this.readWord(this.m_pol,g+2)),0<c&&0<g&&(a.scale(c,g),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill());else if(0==f)a.fillRect(c,b,m,m);else{a.beginPath();a.moveTo(c,b);for(h=0;h<f;++h)d=this.toSignedByte(this.readByte(this.m_pol,g)),g++,e=this.toSignedByte(this.readByte(this.m_pol,g)),g++,c+=d,b+=e,a.lineTo(c,b);a.closePath();2>f?a.stroke():a.fill()}a.restore()},readUint16BE:function(a,c){var b=256*a.charCodeAt(c);
return b+=a.charCodeAt(c+1)},readUint32BE:function(a,c){var b=this.readUint16BE(a,c)<<16;return b|=this.readUint16BE(a,c+2)},decode:function(a,c){var b=0,d=this.readUint32BE(a,b),b=b+4;console.log("POL size="+d);if(d&-2147483648)d=4294967296-d,this.m_pol=a.slice(b,b+d);else{this.readUint32BE(a,b+d-4);var e=a.slice(b,b+d);this.m_pol=decoder.decode(e)}b+=d;d=this.readUint32BE(a,b);b+=4;console.log("CMD size="+d);d&-2147483648?this.m_cmd=a.slice(b,b+(4294967296-d)):(this.readUint32BE(a,b+d-4),b=a.slice(b,
b+d),this.m_cmd=decoder.decode(b))}},player_set={m_pos:0,m_playing:!1,m_scale:2,m_backgroundShapeOffsets:null,m_foregroundShapeOffsets:null,m_palette:Array(16),m_shapePoints:null,m_rotationDataOffset:0,init:function(a){this.m_canvas=document.getElementById(a)},start:function(a){this.m_pos=10;a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;console.log("frames="+a);this.m_rotationPos=this.m_rotationDataOffset;this.m_playing=!0;this.m_timer=setInterval(function(){player_set.doTick()},100)},stop:function(){this.m_playing=
!1;this.m_timer&&(clearInterval(this.m_timer),this.m_timer=null)},toSignedWord:function(a){return a-((a&32768)<<1)},doTick:function(){this.m_playing&&this.drawNextFrame()},readPalette:function(a){a+=12;for(var c=0;16>c;c++){var b=this.readWord(this.m_set,a);a+=2;var d=b>>4&15,e=b&15;this.m_palette[c]="#"+(b>>8&15).toString(16)+d.toString(16)+e.toString(16)}},drawShape:function(a,c){this.readPalette(c.offset+c.size);for(var b=c.offset,d=this.readWord(this.m_set,b),b=b+2,e=0;e<d-1;++e){var b=b+5,f=
this.readByte(this.m_set,b);++b;var k=this.toSignedWord(this.readWord(this.m_set,b)),b=b+2,h=this.toSignedWord(this.readWord(this.m_set,b)),b=b+2,g=this.readByte(this.m_set,b);++b;this.readByte(this.m_set,b);++b;a.save();a.fillStyle=a.strokeStyle=this.m_palette[g];if(255==f)f=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,g=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,0<f&&0<g&&(a.translate(k,h),a.scale(f,g),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill());else{a.beginPath();
for(k=0;k<f;++k)h=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,g=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,0==k?a.moveTo(h,g):a.lineTo(h,g);a.closePath();2>f?a.stroke():a.fill()}a.restore()}},drawNextFrame:function(){var a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;if(65535==a)this.m_playing=!1;else{var c=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;var b=this.m_canvas.getContext("2d");b.fillStyle="#000";b.fillRect(0,0,this.m_canvas.width,this.m_canvas.height);b.save();
b.scale(this.m_scale,this.m_scale);this.drawShape(b,this.m_backgroundShapeOffsets[a],0,0);for(var d=0;d<c;++d){a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;var e=this.toSignedWord(this.readWord(this.m_set,this.m_pos));this.m_pos+=2;var f=this.toSignedWord(this.readWord(this.m_set,this.m_pos));this.m_pos+=2;b.save();if(0!=this.m_rotationPos){var k=this.readWord(this.m_set,this.m_rotationPos);this.m_rotationPos+=2;var h=this.readWord(this.m_set,this.m_rotationPos);this.m_rotationPos+=2;console.assert(180==
h);h=this.readWord(this.m_set,this.m_rotationPos);this.m_rotationPos+=2;console.assert(90==h);0!=k&&(b.translate(e+this.m_shapePoints[a].ox,f+this.m_shapePoints[a].oy),b.rotate(-k*Math.PI/180),e=-this.m_shapePoints[a].ox,f=-this.m_shapePoints[a].oy)}b.translate(e,f);this.drawShape(b,this.m_foregroundShapeOffsets[a]);b.restore()}b.restore()}},readByte:function(a,c){return a.charCodeAt(c)},readWord:function(a,c){var b=256*a.charCodeAt(c);return b+=a.charCodeAt(c+1)},readShapeOffset:function(a,c){var b=
this.readWord(a,c);c+=2;for(var d=0;d<b-1;++d){c+=5;var e=this.readByte(a,c);++c;c+=6;c=255==e?c+4:c+4*e}return c},decode:function(a,c){this.m_shapePoints=[];this.m_rotationDataOffset=0;33322==c&&this.readRotationData(a,17466);this.m_backgroundShapeOffsets=[];var b=this.readWord(a,c);c+=2;console.log("SET bg="+b);for(var d=0;d<b;++d){var e=this.readShapeOffset(a,c);this.m_backgroundShapeOffsets.push({offset:c,size:e-c});c=e+45}this.m_foregroundShapeOffsets=[];b=this.readWord(a,c);c+=2;console.log("SET fg="+
b);for(d=0;d<b;++d)e=this.readShapeOffset(a,c),this.m_foregroundShapeOffsets.push({offset:c,size:e-c}),c=e+45;this.m_set=a},readRotationData:function(a,c){c+=2;var b=this.readWord(a,c);c+=2;for(var d=0;d<b;++d){var e=this.readWord(a,c);c+=2;var f=this.readWord(a,c);c+=2;this.m_shapePoints.push({ox:e,oy:f})}this.m_rotationDataOffset=c+2}};
