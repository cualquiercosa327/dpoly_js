var strings_en={0:"That's my story,|just the way I lived it.",1:"The galaxy I am in|today doesn't|appear on any of|our navigation|charts.",2:"It's impossible|for me to calculate|my return|trajectory.",3:"I'll probably drift|in space for a very|long time...",36:"Hey, it's me!",37:"Hi Conrad. You must be|wondering how you recorded|this message without|remembering it.",38:"Good question, but it would|take too long to explain|and time is short, and if|you want to save your hide...",39:" You must contact your old| friend Ian in New| Washington.",
40:"He'll explain it all there.|Good luck and watch your|back,because it's my life|you're playing with.",41:"Slowly, the rays from the|regenerator re-implant the|memories in Conrad's brain.",42:"The end-of-year thesis.",43:"Glasses which measure|molecular density.",44:"Individuals whose molecular|density is a thousand times|the norm.",45:"Aliens mixed in with the|population.",46:"My investigations have|attracted their attention.",47:"I'm no longer safe.",48:"I'm recording the hologram.",49:"Then I save the contents of|my memory and send it to Ian.",
50:"The kidnapping...",51:'"I HAVE ERASED HIS MEMORY."',52:"Fog...",53:"A minute's rest.",54:"EVASION...",55:"OOOPS! A reunion.",56:"Brothers I congratulate you.",57:"Thanks to our knowledge,|the humans are now capable|of producing...",58:"...the power which we need.",59:"Soon,millions of our brother|warriors will be teleported...",60:"and we will wipe out this|human vermin.",63:"AAARGHHH!!!",65:"A SPY... Throw the wretch|into the dungeons.",66:"We'll|interrogate him later.",67:"We have a winner! Allow me to|present Conrad.",
68:"My dear Conrad,TITAN TRAVEL|is happy to award you this|superb journey to Earth.",69:'Some hours later, Conrad|boards the "Star Providence"|-destination: EARTH.'},strings_fr={0:"VOILA MON HISTOIRE|TELLE QUE JE L'AI VECUE.",1:"LA GALAXIE OU JE ME|TROUVE AUJOURD'HUI|N'EST REPERTORIEE|SUR AUCUNE DE|MES CARTES DE|NAVIGATION.",2:"IL M'EST IMPOSSIBLE|DE CALCULER MA|TRAJECTOIRE DE|RETOUR.",3:"JE VAIS PROBABLEMENT DERIVER|DANS L'ESPACE PENDANT|TRES LONGTEMPS...",36:"EH, MAIS C'EST MOI!",37:"SALUT CONRAD! TU TE DEMANDES|SUREMENT COMMENT TU AS PU|ENREGISTRER CE MESSAGE SANS|T'EN SOUVENIR.",
38:"BONNE QUESTION MAIS CE SERAIT|TROP LONG A EXPLIQUER CAR LE|TEMPS PRESSE ET SI TU TIENS|A TA PEAU...",39:"IL FAUT QUE TU|CONTACTES TON VIEIL AMI IAN A|NEW WASHINGTON.",40:"LA, IL T'EXPLIQUERA TOUT.|BONNE CHANCE ET FAIS GAFFE|PARCE QUE C'EST MA PEAU QUE|TU VAS JOUER.",41:"LENTEMENT, LE FAISCEAU DU|REGENERATEUR REGRAVE LES|SOUVENIRS DANS LA MEMOIRE|DE CONRAD.",42:"LA THESE DE FIN D'ETUDES.",43:"DES LUNETTES QUI MESURENT LA|DENSITE MOLECULAIRE.",44:"DES INDIVIDUS DONT LA DENSITE|MOLECULAIRE EST MILLE FOIS|SUPERIEURE A LA NORMALE.",
45:"DES EXTRA-TERRESTRES|DISSIMULES PARMI|LA POPULATION.",46:"MES RECHERCHES ONT ATTIRE|LEUR ATTENTION.",47:"JE NE SUIS PLUS EN SECURITE.",48:"J'ENREGISTRE L'HOLOGRAMME.",49:"PUIS JE SAUVEGARDE LE CONTENU|DE MA MEMOIRE|ET JE L'EXPEDIE A IAN.",50:"LE KIDNAPPING...",51:'"J\'AI EFFACE SA MEMOIRE."',52:"BROUILLARD...",53:"UN INSTANT DE REPIT.",54:"EVASION...",55:"OOPS! UNE REUNION.",56:"MES FRERES,JE VOUS FELICITE.",57:"GRACE A NOTRE SAVOIR,|LES HUMAINS SONT MAINTENANT|CAPABLES DE PRODUIRE...",58:"...L'ENERGIE DONT NOUS AVONS|BESOIN.",
59:"BIENTOT DES MILLIONS DE|FRERES GUERRIERS POURRONT|ETRE TELEPORTES...",60:"ET NOUS|ECRASERONS CETTE VERMINE|HUMAINE.",63:"AAAAHHH",65:"EUH..SALUT,JE NE FAIS QUE|PASSER.",66:"UN ESPION... METTEZ CE|MISERABLE AU CACHOT. NOUS|L'INTERROGERONS PLUS TARD.",67:"C'EST UN GAGNANT! LAISSEZ-MOI|VOUS PRESENTER CONRAD LE|GRAND VAINQUEUR DE CE SOIR.",68:"CHER CONRAD, TITAN TRAVEL|A LE PLAISIR DE VOUS OFFRIR CE|SUPERBE VOYAGE POUR LA TERRE.",69:'QUELQUES HEURES PLUS TARD,|CONRAD EMBARQUE SUR LE "STAR|PROVIDENCE",DIRECTION:TERRE.'},
strings_gr={0:"DAS IST MEINE GESCHICHTE,|SO WIE ICH SIE ERLEBT HABE.",1:"DIE GALAXIS, IN DER|ICH HEUTE BIN,|IST AUF KEINER|NAVIGATIONSKARTE|ZU  FINDEN.",2:"ICH KANN DIE|FLUGBAHN F[R|MEINE R[CKKEHR|NICHT BERECHNEN.",3:"ICH WERDE WAHRSCHEINLICH|SEHR LANGE IM WELTALL|HERUMFLIEGEN...",36:"HEY, ICH BIN'S!",37:"HI CONRAD. SIE SIND SICHER|ERSTAUNT, DASS SIE DIESE|NACHRICHT AUFGEZEICHNET|HABEN, OHNE SICH|DARAN ZU ERINNERN.",38:"GUTE FRAGE, ABER ES W[RDE|ZU LANGE DAUERN, ALLES ZU|ERKLREN.DIE ZEIT IST KURZ,|UND WENN SIE IHRE HAUT|RETTEN WOLLEN...",
39:"SIE M[SSEN MIT IHREM ALTEN|FREUND IAN IN NEW WASHINGTON|KONTAKT AUFNEHMEN.",40:"ER WIRD DORT ALLES ERKLREN.|VIEL GL[CK, ABER SEIEN SIE|BLOSS VORSICHTIG. ES IST MEIN|LEBEN, MIT DEM SIE SPIELEN.",41:"LANGSAM IMPLANTIEREN DIE|STRAHLEN DES REGENERATORS|CONRADS ERINNERUNG|IN SEIN GEHIRN.",42:"DIE THESE AM ENDE DES JAHRES.",43:"GLSER, DIE MOLEKULARE|DICHTE MESSEN.",44:"INDIVIDUEN, DEREN DICHTE|TAUSENDMAL GR]SSER|ALS NORMAL IST.",45:"AUSSERIRDISCHE, DIE SICH UNTER|DAS VOLK GEMISCHT HABEN.",46:"MEINE NACHFORSCHUNGEN HABEN|IHRE AUFMERKSAMKEIT ERREGT.",
47:"ICH BIN NICHT MEHR SICHER.",48:"ICH ZEICHNE DAS HOLOGRAMM AUF.",49:"ICH SPEICHERE MEIN GEDCHTNIS|UND SCHICKE DIES IAN.",50:"DIE ENTF[HRUNG...",51:"SEIN GEDCHTNIS IST AUSRADIERT.",52:"NEBEL...",53:"DIE UNTERHALTEN SICH|JA PRIMA, EINE GUTE...",54:"...GELEGENHEIT ZUM ABHAUEN",55:"HUCH! DIE VERSCHW]RUNG.",56:"BR[DER, ICH GRATULIERE.",57:"DANK UNSERES WISSENS|SIND DIE MENSCHEN|JETZT DAZU IMSTANDE...",58:"ENERGIE F[R UNS|ZU PRODUZIEREN.",59:"BALD WERDEN MILLIONEN UNSERER|BRUDER-KRIEGER TELEPORTIERT...",
60:"UND WIR WERDEN DIESE|HUMAN-SCHDLINGE AUSL]SCHEN. ",63:"AAARGHHH!!!",65:"EIN SPION... WERFT DEN KERL|IN DIE VERLIESE.",66:"WIR WERDEN IHN|SPTER VERH]REN.",67:"WIR HABEN EINEN GEWINNER!|ERLAUBEN SIE, CONRAD|VORZUSTELLEN.",68:"MEIN LIEBER CONRAD, TITAN|REISEN BIETET IHNEN DIESE|GROSSARTIGE REISE ZUR ERDE AN.",69:'EINIGE STUNDEN SPTER BETRITT|CONRAD DIE "STAR PROVIDENCE",|REISEZIEL: ERDE.'},strings_it={0:"QUESTA E 'LA MIA STORIA|AS HO VISSUTO.",1:"GALAXY E SONO|OGGI TROVATI|DO ELENCATO E|SU QUALSIASI DEI|SCHEDE MY|NAVIGAZIONE.",
2:"E 'IMPOSSIBILE ME|CALCOLO DEL MIO|PERCORSO BACK.",3:"IO PROBABILMENTE DRIFT|SPAZIO PER|TEMPO MOLTO LUNGO ...",36:"EH MA SONO IO!",37:"CONRAD CIAO! OTTENETE|APPLICAZIONI COME|SICURAMENTE PU QUESTO|MESSAGGIO SENZA SALVARE|TE RICORDARE.",38:"BUONA DOMANDA MA SAREBBE|TROPPO LUNGO DA SPIEGARE|L'AUTO TEMPO STAMPA E SE|VUOI ALLA VOSTRA PELLE...",39:"DOVRESTI IN CONTATTO CON|IL VECCHIO COMPAGNO DI IAN|A NEW WASHINGTON.",40:"IL TE IT SPIEGARE TUTTO.|BUONA FORTUNA E FARE BONER|PERCHE E LA MIA PELLE CHE| GIOCHERAI.",
41:"LENTAMENTE IL CABLAGGIO|IL RIGENERATORE RE-INCISO|MEMORIE IN MEMORIA| CONRAD.",42:"LA FINE QUESTI STUDI.",43:"OCCHIALI CHE IL|PROVVEDIMENTO DENSITA|MOLECOLARE.",44:"CHE PERSONE DENSITA|MOLECOLARE E MILLE VOLTE|RISPETTO AL NORMALE.",45:"ALIENS OF|NASCOSTO TRA|POPOLAZIONE.",46:"LA MIA RICERCA HANNO ATTIRATO|LORO ATTENZIONE.",47:"IO SONO PIU 'SICUREZZA.",48:"MI SONO REGISTRATO|OLOGRAMMA",49:"POSSO SALVARE IL CONTENUTO|MEMORIA MA|E HO MANDATO UN IAN.",50:"IL RAPIMENTO ...",51:"HO CHIARO MEMORIA SA.",
52:"NEBBIA ...",53:"UN ISTANTE REPIT.",54:"EVASION ...",55:"OOPS! INCONTRO.",56:"MIEI FRATELLI, I WILL ACCOGLIE CON FAVORE.",57:"GRAZIE ALLE NOSTRE|CONOSCENZE GLI ESSERI|UMANI SONO SOCIETA| GRADO DI PRODURRE ...",58:"... ENERGIA CHE|BISOGNO.",59:"PRESTO MILIONI|BROTHERS GUERRIERI|TELETRASPORTATI ...",60:"E NOI|SCHIACCIARE QUESTO VERMINE|UMANO.",63:"AAAAHHH",65:"EUH..SALUT, LO FACCIO|PASSAGGIO.",66:"UNA SPIA... METTERE QUESTA|MISERABILE PRIGIONE. USA|L'INTERROGATE ULTIME.",67:"QUESTO E 'UN VINCITORE!|LET ME PRESENTARVI IL|CONRAD VINCITORE GRANDE|QUESTA SERA.",
68:"CARO CORRADO IL TITAN|VIAGGI E LIETA DI OFFRIRE|QUESTO SUPER VIAGGIO PER|TERRA.",69:'    POCHE ORE DOPO|    CONRAD NAVE SU "STAR|    PROVIDENCE" GESTIONE:|    A MASSA.'},strings_sp={0:"ESA ES MI HISTORIA|DICHA TAL COMO OCURRIO. ",1:"LA GALAXIA EN LA|QUE ME ENCUENTRO NO|APARECE EN NINGUNA|DE NUESTRAS CARTAS|DE NAVEGACION.",2:"ME RESULTA|IMPOSIBLE CALCULAR|MI TRAYECTORIA|DE REGRESO.",3:"PROBABLEMENTE FLOTARE A LA|DERIVA EN EL ESPACIO |POR MUCHO TIEMPO...",36:"EH, PERO SI SOY YO!",37:"SALUDOS CONRAD! DEBES ESTAR |PREGUNTANDOTE COMO HAS   |GRABADO ESTE MENSAJE SIN   |RECORDARLO.   ",
38:"BUENA PREGUNTA PERO TARDARIA |DEMASIADO RESPONDERLA Y EL  |TIEMPO APREMIA. SI QUIERES |SALVARTE ...",39:"DEBES ENCONTRAR|A TU VIEJO AMIGO IAN EN     |NEW WASHINGTON.",40:"EL TE EXPLICARA TODO    .|BUENA SUERTE Y TEN CUIDADO|PUES ES MI VIDA LA QUE ESTA|EN JUEGO.",41:"LENTAMENTE LOS RAYOS DEL |REGENADOR REGRABAN LOS  |RECUERDOS EN LA MEMORIA  |DE CONRAD.",42:"LA THESIS DEL ULTIMO ANO.",43:"ANTEOJOS CAPACES DE MEDIR LA|DENSIDAD MOLECULAR .",44:"INDIVIDUOS CUYA DENSIDAD|MOLECULAR ES MIL VECES|SUPERIOR A LA NORMAL.",
45:"EXTRATERRESTRES MEZCLADOS ENTRE |LA POBLACION .",46:"MI INVESTIGACION ATRAJO|SU ATENCION.   ",47:"YA NO ESTOY SEGURO.         ",48:"GRABO EL HOLOGRAMA.       ",49:"ENTONCES SALVO EL CONTENIDO|DE MI MEMORIA|Y SE LO ENTREGO A IAN.",50:"EL SECUESTRO....",51:'"HE BORRADO SU MEMORIA ."',52:"NIEBLA.......",53:"UN DESCUIDO.........",54:"EVASION...",55:"OOPS! UNA REUNION.",56:"MIS HERMANOS, LOS FELICITO. ",57:"GRACIAS A NUESTRA SABIDURIA|LOS HUMANOS SON AHORA|CAPACES DE PRODUCIR....",58:"..LA ENERGIA QUE NECESITAMOS|       ",
59:"PRONTO MILLONES DE NUESTROS|HERMANOS GUEREROS|SERAN TELEPORTADOS....",60:"Y NOS|ENCARGAREMOS DE ESTA PLAGA|HUMANA. ",63:"AAAAHHH",65:"UN ESPIA!,ARROJENLO AL|CALABOZO..",66:"INTERROGAREMOS A ESTE|INFELIZ MAS TARDETARDE.                       ",67:"TENEMOS UN GANADOR! PERMITANME|PRESENTARLES A CONRAD|EL GRAN VENCEDOR           ",68:"ESTIMADO CONRAD,TITAN TRAVEL|SE COMPLACE EN ENTREGARLE ESTE|ESTUPENDO VIAJE A LA TIERRA. ",69:'UN PAR DE HORAS MAS TARDE,|CONRAD ABORDA LA "STAR|PROVIDENCE",DESTINO:LA TIERRA.'},
decoder={m_src:null,m_src_offset:0,m_dst:null,m_dst_offset:0,m_size:0,m_bits:0,m_crc:0,readWord:function(a,c){var b=a.charCodeAt(c)<<24,b=b|a.charCodeAt(c+1)<<16,b=b|a.charCodeAt(c+2)<<8;return b|=a.charCodeAt(c+3)},nextBit:function(){var a=this.m_bits&1;this.m_bits>>>=1;0==this.m_bits&&(this.m_bits=this.readWord(this.m_src,this.m_src_offset),this.m_src_offset-=4,this.m_crc^=this.m_bits,a=this.m_bits&1,this.m_bits=-2147483648|this.m_bits>>>1);return a},readBits:function(a){for(var c=0,b=0;b<a;b+=
1)c|=this.nextBit()<<a-1-b;return c},copyLiteral:function(a,c){for(var b=this.readBits(a)+c+1,d=0;d<b;d+=1)this.m_dst[this.m_dst_offset]=this.readBits(8),--this.m_dst_offset;this.m_size-=b},copyReference:function(a,c){for(var b=this.readBits(a),d=0;d<c;d+=1)this.m_dst[this.m_dst_offset]=this.m_dst[this.m_dst_offset+b],--this.m_dst_offset;this.m_size-=c},decode:function(a){this.m_src=a;this.m_src_offset=a.length-4;this.m_size=this.readWord(this.m_src,this.m_src_offset);this.m_src_offset-=4;this.m_crc=
this.readWord(this.m_src,this.m_src_offset);this.m_src_offset-=4;this.m_bits=this.readWord(this.m_src,this.m_src_offset);this.m_src_offset-=4;this.m_crc^=this.m_bits;this.m_dst=Array(this.m_size);for(this.m_dst_offset=this.m_size-1;0<this.m_size;)if(this.nextBit())switch(this.readBits(2)){case 3:this.copyLiteral(8,8);break;case 2:this.copyReference(12,this.readBits(8)+1);break;case 1:this.copyReference(10,4);break;case 0:this.copyReference(9,3)}else this.nextBit()?this.copyReference(8,2):this.copyLiteral(3,
0);console.assert(0==this.m_crc);return this.m_dst}},player_cmp={m_pos:0,m_playing:!1,m_yield:0,m_clear:0,m_palette:Array(32),m_scale:2,m_primitives:[],m_savedPrimitives:[],m_fixUpPalette:0,m_strings:strings_en,m_captions:null,init:function(a){this.m_canvas=document.getElementById(a)},start:function(a){this.m_pos=this.readOffset(a);this.m_playing=!0;this.m_captions=null;this.setDefaultPalette();this.m_timer=setInterval(function(){player_cmp.doTick()},15)},stop:function(){this.m_playing=!1;this.m_timer&&
(clearInterval(this.m_timer),this.m_timer=null)},set_clipping:function(a){this.m_scale=a?1:this.m_canvas.width/240},readOffset:function(a){0!=a&&(a=this.readWord(this.m_cmd,2*(a+1)));return 2*(this.readWord(this.m_cmd,0)+1)+a},readByte:function(a,c){return a[c]},readWord:function(a,c){return 256*a[c]+a[c+1]},readNextByte:function(){var a=this.readByte(this.m_cmd,this.m_pos);this.m_pos+=1;return a},readNextWord:function(){var a=this.readWord(this.m_cmd,this.m_pos);this.m_pos+=2;return a},toSignedByte:function(a){return a-
((a&128)<<1)},toSignedWord:function(a){return a-((a&32768)<<1)},doTick:function(){if(this.m_playing)if(0!=this.m_yield)--this.m_yield;else for(;0==this.m_yield;){var a=this.readNextByte();if(a&128){this.m_playing=!1;break}switch(a>>2){case 0:case 5:this.updateScreen();break;case 1:this.m_clear=this.readNextByte();this.clearScreen();break;case 2:this.m_yield=4*this.readNextByte();break;case 3:var c=this.readNextWord(),b=a=0;c&32768&&(c&=32767,a=this.toSignedWord(this.readNextWord()),b=this.toSignedWord(this.readNextWord()));
this.drawShape(c,a,b);break;case 4:a=this.readNextByte();b=this.readNextByte();this.setPalette(a,b);break;case 6:var d=this.readNextWord();65535!=d?d in this.m_strings?this.m_captions=this.m_strings[d]:console.log("Invalid string:"+d):this.m_captions=null;break;case 7:break;case 8:this.m_pos+=3;break;case 9:for(this.updateScreen();255!=this.readNextByte();)this.readNextWord();break;case 10:c=this.readNextWord();b=a=0;c&32768&&(c&=32767,a=this.toSignedWord(this.readNextWord()),b=this.toSignedWord(this.readNextWord()));
var d=512+this.toSignedWord(this.readNextWord()),e=this.readNextByte(),f=this.readNextByte();this.drawShapeScale(c,a,b,d,e,f);break;case 11:c=this.readNextWord();b=a=0;c&32768&&(c&=32767,a=this.toSignedWord(this.readNextWord()),b=this.toSignedWord(this.readNextWord()));d=512;c&16384&&(c&=16383,d+=this.toSignedWord(this.readNextWord()));var e=this.readNextByte(),f=this.readNextByte(),k=this.readNextWord(),h=90;c&8192&&(c&=8191,h=this.readNextWord());var g=180;c&4096&&(c&=4095,g=this.readNextWord());
this.drawShapeScaleRotate(c,a,b,d,e,f,k,h,g);break;case 12:this.m_yield=10;break;case 13:d=this.readNextWord();65535!=d&&(a=this.readNextByte(),b=this.readNextByte(),c=16+(d>>12),d&=4095,d in this.m_strings?this.m_primitives.push({text:this.m_strings[d],x:a,y:b,color:c}):console.log("Invalid string:"+d));break;default:console.log("Invalid opcode:"+a),this.m_playing=!1}}},updateScreen:function(){var a=this.m_canvas.getContext("2d");a.fillStyle=this.m_palette[0];a.fillRect(0,0,this.m_canvas.width,this.m_canvas.height);
for(var c=0;c<this.m_primitives.length;++c){var b=this.m_primitives[c];b.text?this.drawText(a,b.text,b.x,b.y,b.color,!1):(a.globalAlpha=b.alpha?.8:1,this.drawPrimitive(a,b.x,b.y,b.dx,b.dy,b.num,b.color,b.transform),a.globalAlpha=1)}this.m_captions&&this.drawText(a,this.m_captions,0,120,31,!0);this.flipScreen();this.m_yield=5},clearScreen:function(){0!=this.m_clear&&this.flipScreen()},drawShape:function(a,c,b,d){var e=this.readWord(this.m_pol,2);a=this.readWord(this.m_pol,e+2*a);e=this.readWord(this.m_pol,
14);e+=a;a=this.readWord(this.m_pol,e);for(var e=e+2,f,k,h=0;h<a;++h){var g=this.readWord(this.m_pol,e),e=e+2;g&32768?(f=this.toSignedWord(this.readWord(this.m_pol,e)),e+=2,k=this.toSignedWord(this.readWord(this.m_pol,e)),e+=2):k=f=0;var l=0!=(g&16384),m=this.readByte(this.m_pol,e);e++;0==this.m_clear&&(m+=16);this.queuePrimitive(c,b,f,k,g&16383,m,l,d)}0!=this.m_clear&&this.savePrimitives()},drawShapeScale:function(a,c,b,d,e,f){this.drawShape(a,c,b,{z:d,ix:e,iy:f,r1:0,r2:90,r3:180})},drawShapeScaleRotate:function(a,
c,b,d,e,f,k,h,g){this.drawShape(a,c,b,{z:d,ix:e,iy:f,r1:k,r2:h,r3:g})},drawText:function(a,c,b,d,e,f){a.save();a.fillStyle=a.strokeStyle=this.m_palette[e];c=c.split("|");e=8*this.m_scale;b*=e;d*=e;f&&(a.textAlign="center",b=this.m_canvas.width/2,d=this.m_canvas.height-e*(c.length+1));a.font="normal bold "+e+"px monospace";for(f=0;f<c.length;++f)d+=e,a.fillText(c[f],b,d);a.restore()},setDefaultPalette:function(){for(var a=0;16>a;a++){var c="#"+a.toString(16)+a.toString(16)+a.toString(16);this.m_palette[16+
a]=this.m_palette[a]=c}this.m_fixUpPalette=0},setTaxiPalette:function(){for(var a="000 fff 000 886 664 444 aa8 684 ec0 ea0 c60 a40 620 66c 44a e86".split(" "),c=0;16>c;++c)this.m_palette[16+c]="#"+a[c];this.m_fixUpPalette=1},setPalette:function(a,c){var b=this.readWord(this.m_pol,6),b=b+32*a,d=0;if(0==c){if(0!=this.m_fixUpPalette)return;d=16}for(var e=0;16>e;e++){var f=this.readWord(this.m_pol,b),b=b+2,k=f>>4&15,h=f&15;this.m_palette[d]="#"+(f>>8&15).toString(16)+k.toString(16)+h.toString(16);++d}},
flipScreen:function(){0!=this.m_clear?this.clearPrimitives():this.restorePrimitives()},queuePrimitive:function(a,c,b,d,e,f,k,h){this.m_primitives.push({x:a,y:c,dx:b,dy:d,num:e,color:f,alpha:k,transform:h})},clearPrimitives:function(){this.m_primitives.length=0},restorePrimitives:function(){this.m_primitives=this.m_savedPrimitives.slice()},savePrimitives:function(){this.m_savedPrimitives=this.m_primitives.slice()},drawPrimitive:function(a,c,b,d,e,f,k,h){var g=this.readWord(this.m_pol,10);f=this.readWord(this.m_pol,
g+2*f);g=this.readWord(this.m_pol,18);g+=f;f=this.readByte(this.m_pol,g);g++;a.fillStyle=a.strokeStyle=this.m_palette[k];a.save();1==this.m_scale?a.translate((this.m_canvas.width-240)/2,(this.m_canvas.height-128)/2):a.scale(this.m_scale,this.m_scale);k=this.toSignedWord(this.readWord(this.m_pol,g));var g=g+2,l=this.toSignedWord(this.readWord(this.m_pol,g)),g=g+2;a.translate(c,b);c=k+d;b=l+e;h&&(a.translate(h.ix,h.iy),a.rotate(-h.r1*Math.PI/180),c-=h.ix,b-=h.iy,a.scale(h.z/512,h.z/512));if(f&128)a.translate(c,
b),c=this.toSignedWord(this.readWord(this.m_pol,g)),g=this.toSignedWord(this.readWord(this.m_pol,g+2)),0<c&&0<g&&(a.scale(c,g),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill());else if(0==f)a.fillRect(c,b,this.m_scale,this.m_scale);else{a.beginPath();a.moveTo(c,b);for(h=0;h<f;++h)d=this.toSignedByte(this.readByte(this.m_pol,g)),g++,e=this.toSignedByte(this.readByte(this.m_pol,g)),g++,c+=d,b+=e,a.lineTo(c,b);a.closePath();2>f?a.stroke():a.fill()}a.restore()},fixUpEspions:function(){console.assert(0==
this.m_cmd[802]&&24==this.m_cmd[803]&&0==this.m_cmd[804]&&58==this.m_cmd[805]);this.m_cmd[802]=24;this.m_cmd[803]=0;this.m_cmd[804]=58;this.m_cmd[805]=0},set_language:function(a){0==a?this.m_strings=strings_en:1==a?this.m_strings=strings_fr:2==a?this.m_strings=strings_gr:3==a?this.m_strings=strings_it:4==a&&(this.m_strings=strings_sp)},readUint16BE:function(a,c){var b=a.charCodeAt(c)<<8;return b+=a.charCodeAt(c+1)},readUint32BE:function(a,c){var b=this.readUint16BE(a,c)<<16;return b|=this.readUint16BE(a,
c+2)},decode:function(a,c){var b=0,d=this.readUint32BE(a,b),b=b+4;console.log("POL size="+d);if(d&-2147483648)d=4294967296-d,this.m_pol=a.slice(b,b+d);else{this.readUint32BE(a,b+d-4);var e=a.slice(b,b+d);this.m_pol=decoder.decode(e)}b+=d;d=this.readUint32BE(a,b);b+=4;console.log("CMD size="+d);d&-2147483648?this.m_cmd=a.slice(b,b+(4294967296-d)):(this.readUint32BE(a,b+d-4),b=a.slice(b,b+d),this.m_cmd=decoder.decode(b))}},player_set={m_pos:0,m_playing:!1,m_scale:2,m_backgroundShapeOffsets:null,m_foregroundShapeOffsets:null,
m_palette:Array(16),m_shapePoints:null,m_rotationDataOffset:0,init:function(a){this.m_canvas=document.getElementById(a)},start:function(a){this.m_pos=10;a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;console.log("frames="+a);this.m_rotationPos=this.m_rotationDataOffset;this.m_playing=!0;this.m_timer=setInterval(function(){player_set.doTick()},100)},stop:function(){this.m_playing=!1;this.m_timer&&(clearInterval(this.m_timer),this.m_timer=null)},set_clipping:function(a){this.m_scale=a?1:this.m_canvas.width/
240},toSignedWord:function(a){return a-((a&32768)<<1)},doTick:function(){this.m_playing&&this.drawNextFrame()},readPalette:function(a){a+=12;for(var c=0;16>c;c++){var b=this.readWord(this.m_set,a);a+=2;var d=b>>4&15,e=b&15;this.m_palette[c]="#"+(b>>8&15).toString(16)+d.toString(16)+e.toString(16)}},drawShape:function(a,c){this.readPalette(c.offset+c.size);for(var b=c.offset,d=this.readWord(this.m_set,b),b=b+2,e=0;e<d-1;++e){var b=b+5,f=this.readByte(this.m_set,b);++b;var k=this.toSignedWord(this.readWord(this.m_set,
b)),b=b+2,h=this.toSignedWord(this.readWord(this.m_set,b)),b=b+2,g=this.readByte(this.m_set,b);++b;this.readByte(this.m_set,b);++b;a.save();a.fillStyle=a.strokeStyle=this.m_palette[g];if(255==f)f=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,g=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,0<f&&0<g&&(a.translate(k,h),a.scale(f,g),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill());else{a.beginPath();for(k=0;k<f;++k)h=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,g=this.toSignedWord(this.readWord(this.m_set,
b)),b+=2,0==k?a.moveTo(h,g):a.lineTo(h,g);a.closePath();2>f?a.stroke():a.fill()}a.restore()}},drawNextFrame:function(){var a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;if(65535==a)this.m_playing=!1;else{var c=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;var b=this.m_canvas.getContext("2d");b.fillStyle="#000";b.fillRect(0,0,this.m_canvas.width,this.m_canvas.height);b.save();1==this.m_scale?b.translate((this.m_canvas.width-240)/2,(this.m_canvas.height-128)/2):b.scale(this.m_scale,this.m_scale);
this.drawShape(b,this.m_backgroundShapeOffsets[a],0,0);for(var d=0;d<c;++d){a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;var e=this.toSignedWord(this.readWord(this.m_set,this.m_pos));this.m_pos+=2;var f=this.toSignedWord(this.readWord(this.m_set,this.m_pos));this.m_pos+=2;b.save();if(0!=this.m_rotationPos){var k=this.readWord(this.m_set,this.m_rotationPos);this.m_rotationPos+=2;var h=this.readWord(this.m_set,this.m_rotationPos);this.m_rotationPos+=2;console.assert(180==h);h=this.readWord(this.m_set,
this.m_rotationPos);this.m_rotationPos+=2;console.assert(90==h);0!=k&&(b.translate(e+this.m_shapePoints[a].ox,f+this.m_shapePoints[a].oy),b.rotate(-k*Math.PI/180),e=-this.m_shapePoints[a].ox,f=-this.m_shapePoints[a].oy)}b.translate(e,f);this.drawShape(b,this.m_foregroundShapeOffsets[a]);b.restore()}b.restore()}},readByte:function(a,c){return a.charCodeAt(c)},readWord:function(a,c){var b=256*a.charCodeAt(c);return b+=a.charCodeAt(c+1)},readShapeOffset:function(a,c){var b=this.readWord(a,c);c+=2;for(var d=
0;d<b-1;++d){c+=5;var e=this.readByte(a,c);++c;c+=6;c=255==e?c+4:c+4*e}return c},decode:function(a,c){this.m_shapePoints=[];this.m_rotationDataOffset=0;33322==c&&this.readRotationData(a,17466);this.m_backgroundShapeOffsets=[];var b=this.readWord(a,c);c+=2;console.log("SET bg="+b);for(var d=0;d<b;++d){var e=this.readShapeOffset(a,c);this.m_backgroundShapeOffsets.push({offset:c,size:e-c});c=e+45}this.m_foregroundShapeOffsets=[];b=this.readWord(a,c);c+=2;console.log("SET fg="+b);for(d=0;d<b;++d)e=this.readShapeOffset(a,
c),this.m_foregroundShapeOffsets.push({offset:c,size:e-c}),c=e+45;this.m_set=a},readRotationData:function(a,c){c+=2;var b=this.readWord(a,c);c+=2;for(var d=0;d<b;++d){var e=this.readWord(a,c);c+=2;var f=this.readWord(a,c);c+=2;this.m_shapePoints.push({ox:e,oy:f})}this.m_rotationDataOffset=c+2}};
