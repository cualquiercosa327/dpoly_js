var decoder={m_in:null,m_inptr:0,m_out:null,m_outptr:0,m_size:0,m_bits:0,m_crc:0,m_code:0,readWord:function(a,b){for(var c=0,d=0;4>d;d+=1)c*=256,c+=a.charCodeAt(b+d);return c},getBit:function(a){var b=this.m_bits&1;this.m_bits>>>=1;a&&(this.m_bits|=-2147483648);return b},nextBit:function(){var a=this.getBit(0);0==this.m_bits&&(this.m_bits=this.readWord(this.m_in,this.m_inptr),this.m_inptr-=4,this.m_crc^=this.m_bits,a=this.getBit(1));return a},readBits:function(a){for(var b=0,c=0;c<a;c+=1)b*=2,this.nextBit()&&
(b+=1);return b},decodeHelper1:function(a,b){for(var c=this.readBits(a)+b+1,d=0;d<c;d+=1)this.m_out[this.m_outptr]=this.readBits(8),--this.m_outptr;this.m_size-=c},decodeHelper2:function(a){a=this.readBits(a);for(var b=this.m_code+1,c=0;c<b;c+=1)this.m_out[this.m_outptr]=this.m_out[this.m_outptr+a],--this.m_outptr;this.m_size-=b},decode:function(a){this.m_in=a;this.m_inptr=a.length-4;this.m_size=this.readWord(this.m_in,this.m_inptr);this.m_inptr-=4;this.m_crc=this.readWord(this.m_in,this.m_inptr);
this.m_inptr-=4;this.m_bits=this.readWord(this.m_in,this.m_inptr);this.m_inptr-=4;this.m_crc^=this.m_bits;this.m_out=Array(this.m_size);for(this.m_outptr=this.m_size-1;0<this.m_size;)if(this.nextBit())switch(a=this.readBits(2),a){case 3:this.decodeHelper1(8,8);break;case 2:this.m_code=this.readBits(8);this.decodeHelper2(12);break;default:this.m_code=a+2,this.decodeHelper2(a+9)}else this.m_code=1,this.nextBit()?this.decodeHelper2(8):this.decodeHelper1(3,0);return 0==this.m_crc}},player_cmp={m_pos:0,
m_playing:!1,m_yield:0,m_clear:0,m_palette:Array(32),m_scale:2,m_primitives:[],m_savedPrimitives:[],m_fixUpPalette:0,init:function(a){this.m_canvas=document.getElementById(a)},start:function(a){this.m_pos=this.readOffset(a);this.m_playing=!0;this.setDefaultPalette();this.m_timer=setInterval(function(){player_cmp.doTick()},15)},stop:function(){this.m_playing=!1;this.m_timer&&(clearInterval(this.m_timer),this.m_timer=null)},readOffset:function(a){0!=a&&(a=this.readWord(this.m_cmd,2*(a+1)));return 2*
(this.readWord(this.m_cmd,0)+1)+a},readByte:function(a,b){return a[b]},readWord:function(a,b){return 256*a[b]+a[b+1]},readNextByte:function(){var a=this.readByte(this.m_cmd,this.m_pos);this.m_pos+=1;return a},readNextWord:function(){var a=this.readWord(this.m_cmd,this.m_pos);this.m_pos+=2;return a},toSignedByte:function(a){return a-((a&128)<<1)},toSignedWord:function(a){return a-((a&32768)<<1)},doTick:function(){if(this.m_playing)if(0!=this.m_yield)--this.m_yield;else for(;0==this.m_yield;){var a=
this.readNextByte();if(a&128){this.m_playing=!1;break}switch(a>>2){case 0:case 5:case 9:this.updateScreen();break;case 1:this.m_clear=this.readNextByte();this.clearScreen();break;case 2:this.m_yield=4*this.readNextByte();break;case 3:var a=this.readNextWord(),b=0,c=0;a&32768&&(a&=32767,b=this.toSignedWord(this.readNextWord()),c=this.toSignedWord(this.readNextWord()));this.drawShape(a,b,c);break;case 4:a=this.readNextByte();b=this.readNextByte();this.setPalette(a,b);break;case 6:a=this.readNextWord();
break;case 7:break;case 8:this.m_pos+=3;break;case 10:a=this.readNextWord();c=b=0;a&32768&&(a&=32767,b=this.toSignedWord(this.readNextWord()),c=this.toSignedWord(this.readNextWord()));var d=512+this.toSignedWord(this.readNextWord()),e=this.readNextByte(),g=this.readNextByte();this.drawShapeScale(a,b,c,d,e,g);break;case 11:a=this.readNextWord();c=b=0;a&32768&&(a&=32767,b=this.toSignedWord(this.readNextWord()),c=this.toSignedWord(this.readNextWord()));d=512;a&16384&&(a&=16383,d+=this.toSignedWord(this.readNextWord()));
var e=this.readNextByte(),g=this.readNextByte(),k=this.readNextWord(),h=90;a&8192&&(a&=8191,h=this.readNextWord());var f=180;a&4096&&(a&=4095,f=this.readNextWord());this.drawShapeScaleRotate(a,b,c,d,e,g,k,h,f);break;case 12:this.m_yield=10;break;case 13:a=this.readNextWord();65535!=a&&(this.readNextByte(),this.readNextByte());break;default:console.log("Invalid opcode="+a),this.m_playing=!1}}},updateScreen:function(){var a=this.m_canvas.getContext("2d");a.fillStyle="#000";a.fillRect(0,0,this.m_canvas.width,
this.m_canvas.height);for(var b=0;b<this.m_primitives.length;b++){var c=this.m_primitives[b];a.globalAlpha=c.alpha?.8:1;this.drawPrimitive(a,c.x,c.y,c.dx,c.dy,c.num,c.color,c.transform);a.globalAlpha=1}this.flipScreen();this.m_yield=5},clearScreen:function(){0!=this.m_clear&&this.flipScreen()},drawShape:function(a,b,c,d){var e=this.readWord(this.m_pol,2);a=this.readWord(this.m_pol,e+2*a);e=this.readWord(this.m_pol,14);e+=a;a=this.readWord(this.m_pol,e);for(var e=e+2,g,k,h=0;h<a;++h){var f=this.readWord(this.m_pol,
e),e=e+2;f&32768?(g=this.toSignedWord(this.readWord(this.m_pol,e)),e+=2,k=this.toSignedWord(this.readWord(this.m_pol,e)),e+=2):k=g=0;var l=0!=(f&16384),m=this.readByte(this.m_pol,e);e++;0==this.m_clear&&(m+=16);this.queuePrimitive(b,c,g,k,f&16383,m,l,d)}0!=this.m_clear&&this.savePrimitives()},drawShapeScale:function(a,b,c,d,e,g){this.drawShape(a,b,c,{z:d,ix:e,iy:g})},drawShapeScaleRotate:function(a,b,c,d,e,g,k,h,f){this.drawShape(a,b,c,{z:d,ix:e,iy:g,r1:k,r2:h,r3:f})},setDefaultPalette:function(){for(var a=
0;16>a;a++){var b="#"+a.toString(16)+a.toString(16)+a.toString(16);this.m_palette[16+a]=this.m_palette[a]=b}this.m_fixUpPalette=0},setTaxiPalette:function(){for(var a="000 fff 000 886 664 444 aa8 684 ec0 ea0 c60 a40 620 66c 44a e86".split(" "),b=0;16>b;++b)this.m_palette[16+b]="#"+a[b];this.m_fixUpPalette=1},setPalette:function(a,b){var c=this.readWord(this.m_pol,6),c=c+32*a,d=0;if(0==b){if(0!=this.m_fixUpPalette)return;d=16}for(var e=0;16>e;e++){var g=this.readWord(this.m_pol,c),c=c+2,k=g>>4&15,
h=g&15;this.m_palette[d]="#"+(g>>8&15).toString(16)+k.toString(16)+h.toString(16);++d}},flipScreen:function(){0!=this.m_clear?this.clearPrimitives():this.restorePrimitives()},queuePrimitive:function(a,b,c,d,e,g,k,h){this.m_primitives.push({x:a,y:b,dx:c,dy:d,num:e,color:g,alpha:k,transform:h})},clearPrimitives:function(){this.m_primitives=[]},restorePrimitives:function(){this.m_primitives=this.m_savedPrimitives.slice()},savePrimitives:function(){this.m_savedPrimitives=this.m_primitives.slice()},drawPrimitive:function(a,
b,c,d,e,g,k,h){var f=this.readWord(this.m_pol,10);g=this.readWord(this.m_pol,f+2*g);f=this.readWord(this.m_pol,18);f+=g;g=this.readByte(this.m_pol,f);f++;var l=this.m_scale;a.fillStyle=a.strokeStyle=this.m_palette[k];a.save();a.scale(l,l);k=this.toSignedWord(this.readWord(this.m_pol,f));var f=f+2,m=this.toSignedWord(this.readWord(this.m_pol,f)),f=f+2;h&&(a.translate(h.ix,h.iy),a.scale(h.z/512,h.z/512),k-=h.ix,m-=h.iy);b+=k+d;c+=m+e;if(g&128)a.translate(b,c),b=this.toSignedWord(this.readWord(this.m_pol,
f)),f=this.toSignedWord(this.readWord(this.m_pol,f+2)),0<b&&0<f&&(a.scale(b,f),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill());else if(0==g)a.fillRect(b,c,l,l);else{a.beginPath();a.moveTo(b,c);for(h=0;h<g;++h)d=this.toSignedByte(this.readByte(this.m_pol,f)),f++,e=this.toSignedByte(this.readByte(this.m_pol,f)),f++,b+=d,c+=e,a.lineTo(b,c);a.closePath();2>g?a.stroke():a.fill()}a.restore()},readUint16BE:function(a,b){var c=256*a.charCodeAt(b);return c+=a.charCodeAt(b+1)},readUint32BE:function(a,
b){var c=this.readUint16BE(a,b)<<16;return c|=this.readUint16BE(a,b+2)},decode:function(a,b){var c=0,d=this.readUint32BE(a,c),c=c+4;console.log("POL size="+d);if(d&-2147483648)d=4294967296-d,this.m_pol=a.slice(c,c+d);else{this.readUint32BE(a,c+d-4);var e=a.slice(c,c+d);decoder.decode(e);this.m_pol=decoder.m_out}c+=d;d=this.readUint32BE(a,c);c+=4;console.log("CMD size="+d);d&-2147483648?this.m_cmd=a.slice(c,c+(4294967296-d)):(this.readUint32BE(a,c+d-4),c=a.slice(c,c+d),decoder.decode(c),this.m_cmd=
decoder.m_out)}},player_set={m_pos:0,m_playing:!1,m_scale:2,m_backgroundShapeOffsets:null,m_foregroundShapeOffsets:null,m_palette:Array(16),init:function(a){this.m_canvas=document.getElementById(a)},start:function(a){this.m_pos=10;a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;console.log("frames="+a);this.m_playing=!0;this.m_timer=setInterval(function(){player_set.doTick()},100)},stop:function(){this.m_playing=!1;this.m_timer&&(clearInterval(this.m_timer),this.m_timer=null)},toSignedWord:function(a){return a-
((a&32768)<<1)},doTick:function(){this.m_playing&&this.drawNextFrame()},readPalette:function(a){a+=12;for(var b=0;16>b;b++){var c=this.readWord(this.m_set,a);a+=2;var d=c>>4&15,e=c&15;this.m_palette[b]="#"+(c>>8&15).toString(16)+d.toString(16)+e.toString(16)}},drawShape:function(a,b,c,d){this.readPalette(b.offset+b.size);b=b.offset;var e=this.readWord(this.m_set,b);b+=2;for(var g=0;g<e-1;++g){b+=5;var k=this.readByte(this.m_set,b);++b;var h=this.toSignedWord(this.readWord(this.m_set,b));b+=2;var f=
this.toSignedWord(this.readWord(this.m_set,b));b+=2;var l=this.readByte(this.m_set,b);++b;this.readByte(this.m_set,b);++b;a.save();a.fillStyle=a.strokeStyle=this.m_palette[l];if(255==k)k=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,l=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,0<k&&0<l&&(a.translate(h+c,f+d),a.scale(k,l),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill());else{a.beginPath();for(h=0;h<k;++h)f=this.toSignedWord(this.readWord(this.m_set,b)),b+=2,l=this.toSignedWord(this.readWord(this.m_set,
b)),b+=2,0==h?a.moveTo(f+c,l+d):a.lineTo(f+c,l+d);a.closePath();2>k?a.stroke():a.fill()}a.restore()}},drawNextFrame:function(){var a=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;var b=this.readWord(this.m_set,this.m_pos);this.m_pos+=2;if(0==b)this.m_playing=!1;else{var c=this.m_canvas.getContext("2d");c.fillStyle="#000";c.fillRect(0,0,this.m_canvas.width,this.m_canvas.height);c.save();c.scale(this.m_scale,this.m_scale);this.drawShape(c,this.m_backgroundShapeOffsets[a],0,0);for(var d=0;d<b;++d){a=
this.readWord(this.m_set,this.m_pos);this.m_pos+=2;var e=this.toSignedWord(this.readWord(this.m_set,this.m_pos));this.m_pos+=2;var g=this.toSignedWord(this.readWord(this.m_set,this.m_pos));this.m_pos+=2;this.drawShape(c,this.m_foregroundShapeOffsets[a],e,g)}c.restore()}},readByte:function(a,b){return a.charCodeAt(b)},readWord:function(a,b){var c=256*a.charCodeAt(b);return c+=a.charCodeAt(b+1)},readShapeOffset:function(a,b){var c=this.readWord(a,b);b+=2;for(var d=0;d<c-1;++d){b+=5;var e=this.readByte(a,
b);++b;b+=6;b=255==e?b+4:b+4*e}return b},decode:function(a,b){this.m_backgroundShapeOffsets=[];var c=this.readWord(a,b);b+=2;console.log("SET bg="+c);for(var d=0;d<c;++d){var e=this.readShapeOffset(a,b);this.m_backgroundShapeOffsets.push({offset:b,size:e-b});b=e+45}this.m_foregroundShapeOffsets=[];c=this.readWord(a,b);b+=2;console.log("SET fg="+c);for(d=0;d<c;++d)e=this.readShapeOffset(a,b),this.m_foregroundShapeOffsets.push({offset:b,size:e-b}),b=e+45;this.m_set=a}};
