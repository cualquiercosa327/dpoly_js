var decoder={m_in:null,m_inptr:0,m_out:null,m_outptr:0,m_size:0,m_bits:0,m_crc:0,m_code:0,readWord:function(a,b){for(var c=0,e=0;4>e;e+=1)c*=256,c+=a.charCodeAt(b+e);return c},getBit:function(a){var b=this.m_bits&1;this.m_bits>>>=1;a&&(this.m_bits|=-2147483648);return b},nextBit:function(){var a=this.getBit(0);0==this.m_bits&&(this.m_bits=this.readWord(this.m_in,this.m_inptr),this.m_inptr-=4,this.m_crc^=this.m_bits,a=this.getBit(1));return a},readBits:function(a){for(var b=0,c=0;c<a;c+=1)b*=2,this.nextBit()&&
(b+=1);return b},decodeHelper1:function(a,b){for(var c=this.readBits(a)+b+1,e=0;e<c;e+=1)this.m_out[this.m_outptr]=this.readBits(8),--this.m_outptr;this.m_size-=c},decodeHelper2:function(a){a=this.readBits(a);for(var b=this.m_code+1,c=0;c<b;c+=1)this.m_out[this.m_outptr]=this.m_out[this.m_outptr+a],--this.m_outptr;this.m_size-=b},decode:function(a){this.m_in=a;this.m_inptr=a.length-4;this.m_size=this.readWord(this.m_in,this.m_inptr);this.m_inptr-=4;this.m_crc=this.readWord(this.m_in,this.m_inptr);
this.m_inptr-=4;this.m_bits=this.readWord(this.m_in,this.m_inptr);this.m_inptr-=4;this.m_crc^=this.m_bits;this.m_out=Array(this.m_size);for(this.m_outptr=this.m_size-1;0<this.m_size;)if(this.nextBit())switch(a=this.readBits(2),a){case 3:this.decodeHelper1(8,8);break;case 2:this.m_code=this.readBits(8);this.decodeHelper2(12);break;default:this.m_code=a+2,this.decodeHelper2(a+9)}else this.m_code=1,this.nextBit()?this.decodeHelper2(8):this.decodeHelper1(3,0);return 0==this.m_crc}},player={m_startPos:0,
m_pos:0,m_playing:!1,m_yield:0,m_clear:0,m_palette:Array(32),m_scale:2,m_opcode:255,m_primitives:[],m_savedPrimitives:[],m_fixUpPalette:0,init:function(a){this.m_canvas=document.getElementById(a);this.m_timer=setInterval(function(){player.doTick()},15)},start:function(a){this.m_pos=this.m_startPos=this.readOffset(a);this.m_playing=!0;this.setDefaultPalette()},pause:function(){this.m_playing=!this.m_playing},readOffset:function(a){0!=a&&(a=this.readWord(this.m_cmd,2*(a+1)));return 2*(this.readWord(this.m_cmd,
0)+1)+a},readByte:function(a,b){return a[b]},readWord:function(a,b){return 256*a[b]+a[b+1]},readNextByte:function(){var a=this.readByte(this.m_cmd,this.m_pos);this.m_pos+=1;return a},readNextWord:function(){var a=this.readWord(this.m_cmd,this.m_pos);this.m_pos+=2;return a},toSignedByte:function(a){return a-((a&128)<<1)},toSignedWord:function(a){return a-((a&32768)<<1)},doTick:function(){if(this.m_playing)if(0!=this.m_yield)--this.m_yield;else for(;0==this.m_yield;){var a=this.readNextByte();if(a&
128){this.m_playing=!1;break}this.m_opcode=a>>2;switch(this.m_opcode){case 0:case 5:case 9:this.updateScreen();break;case 1:this.m_clear=this.readNextByte();this.clearScreen();break;case 2:this.m_yield=4*this.readNextByte();break;case 3:var a=this.readNextWord(),b=0,c=0;a&32768&&(a&=32767,b=this.toSignedWord(this.readNextWord()),c=this.toSignedWord(this.readNextWord()));this.drawShape(a,b,c);break;case 4:a=this.readNextByte();b=this.readNextByte();this.setPalette(a,b);break;case 6:a=this.readNextWord();
break;case 7:break;case 8:this.m_pos+=3;break;case 10:a=this.readNextWord();c=b=0;a&32768&&(a&=32767,b=this.toSignedWord(this.readNextWord()),c=this.toSignedWord(this.readNextWord()));var e=512+this.toSignedWord(this.readNextWord()),d=this.readNextByte(),g=this.readNextByte();this.drawShapeScale(a,b,c,e,d,g);break;case 11:a=this.readNextWord();c=b=0;a&32768&&(a&=32767,b=this.toSignedWord(this.readNextWord()),c=this.toSignedWord(this.readNextWord()));e=512;a&16384&&(a&=16383,e+=this.toSignedWord(this.readNextWord()));
var d=this.readNextByte(),g=this.readNextByte(),k=this.readNextWord(),h=90;a&8192&&(a&=8191,h=this.readNextWord());var f=180;a&4096&&(a&=4095,f=this.readNextWord());this.drawShapeScaleRotate(a,b,c,e,d,g,k,h,f);break;case 12:this.m_yield=10;break;case 13:a=this.readNextWord();65535!=a&&(this.readNextByte(),this.readNextByte());break;default:console.log("Invalid opcode="+a),this.m_playing=!1}}},updateScreen:function(){var a=this.m_canvas.getContext("2d");a.fillStyle="#000";a.fillRect(0,0,this.m_canvas.width,
this.m_canvas.height);for(var b=0;b<this.m_primitives.length;b++){var c=this.m_primitives[b];a.globalAlpha=c.alpha?.8:1;this.drawPrimitive(a,c.x,c.y,c.dx,c.dy,c.num,c.color,c.transform);a.globalAlpha=1}this.flipScreen();this.m_yield=5},clearScreen:function(){0!=this.m_clear&&this.flipScreen()},drawShape:function(a,b,c,e){var d=this.readWord(this.m_pol,2);a=this.readWord(this.m_pol,d+2*a);d=this.readWord(this.m_pol,14);d+=a;a=this.readWord(this.m_pol,d);for(var d=d+2,g,k,h=0;h<a;++h){var f=this.readWord(this.m_pol,
d),d=d+2;f&32768?(g=this.toSignedWord(this.readWord(this.m_pol,d)),d+=2,k=this.toSignedWord(this.readWord(this.m_pol,d)),d+=2):k=g=0;var m=0!=(f&16384),l=this.readByte(this.m_pol,d);d++;0==this.m_clear&&(l+=16);this.queuePrimitive(b,c,g,k,f&16383,l,m,e)}0!=this.m_clear&&this.savePrimitives()},drawShapeScale:function(a,b,c,e,d,g){this.drawShape(a,b,c,{z:e,ix:d,iy:g})},drawShapeScaleRotate:function(a,b,c,e,d,g,k,h,f){this.drawShape(a,b,c,{z:e,ix:d,iy:g,r1:k,r2:h,r3:f})},setDefaultPalette:function(){for(var a=
0;16>a;a++){var b="#"+a.toString(16)+a.toString(16)+a.toString(16);this.m_palette[16+a]=this.m_palette[a]=b}this.m_fixUpPalette=0},setTaxiPalette:function(){for(var a="000 fff 000 886 664 444 aa8 684 ec0 ea0 c60 a40 620 66c 44a e86".split(" "),b=0;16>b;++b)this.m_palette[16+b]="#"+a[b];this.m_fixUpPalette=1},setPalette:function(a,b){var c=this.readWord(this.m_pol,6),c=c+32*a,e=0;if(0==b){if(0!=this.m_fixUpPalette)return;e=16}for(var d=0;16>d;d++){var g=this.readWord(this.m_pol,c),c=c+2,k=g>>4&15,
h=g&15;this.m_palette[e]="#"+(g>>8&15).toString(16)+k.toString(16)+h.toString(16);++e}},flipScreen:function(){0!=this.m_clear?this.clearPrimitives():this.restorePrimitives()},queuePrimitive:function(a,b,c,e,d,g,k,h){this.m_primitives.push({x:a,y:b,dx:c,dy:e,num:d,color:g,alpha:k,transform:h})},clearPrimitives:function(){this.m_primitives=[]},restorePrimitives:function(){this.m_primitives=this.m_savedPrimitives.slice()},savePrimitives:function(){this.m_savedPrimitives=this.m_primitives.slice()},drawPrimitive:function(a,
b,c,e,d,g,k,h){var f=this.readWord(this.m_pol,10);g=this.readWord(this.m_pol,f+2*g);f=this.readWord(this.m_pol,18);f+=g;g=this.readByte(this.m_pol,f);f++;var m=this.m_scale;a.fillStyle=a.strokeStyle=this.m_palette[k];a.save();a.scale(m,m);k=this.toSignedWord(this.readWord(this.m_pol,f));var f=f+2,l=this.toSignedWord(this.readWord(this.m_pol,f)),f=f+2;h&&(a.translate(h.ix,h.iy),a.scale(h.z/512,h.z/512),k-=h.ix,l-=h.iy);b+=k+e;c+=l+d;if(g&128)a.translate(b,c),b=this.toSignedWord(this.readWord(this.m_pol,
f)),f=this.toSignedWord(this.readWord(this.m_pol,f+2)),a.scale(b,f),a.beginPath(),a.arc(0,0,1,0,2*Math.PI,!1),a.closePath(),a.fill();else if(0==g)a.fillRect(b,c,m,m);else{a.beginPath();a.moveTo(b,c);for(h=0;h<g;++h)e=this.toSignedByte(this.readByte(this.m_pol,f)),f++,d=this.toSignedByte(this.readByte(this.m_pol,f)),f++,b+=e,c+=d,a.lineTo(b,c);a.closePath();2>g?a.stroke():a.fill()}a.restore()},readUint16BE:function(a,b){var c=256*a.charCodeAt(b);return c+=a.charCodeAt(b+1)},readUint32BE:function(a,
b){var c=this.readUint16BE(a,b)<<16;return c|=this.readUint16BE(a,b+2)},decode:function(a){var b=0,c=this.readUint32BE(a,b),b=b+4;console.log("POL size="+c);if(c&-2147483648)c=4294967296-c,this.m_pol=a.slice(b,b+c);else{this.readUint32BE(a,b+c-4);var e=a.slice(b,b+c);decoder.decode(e);this.m_pol=decoder.m_out}b+=c;c=this.readUint32BE(a,b);b+=4;console.log("CMD size="+c);c&-2147483648?this.m_cmd=a.slice(b,b+(4294967296-c)):(this.readUint32BE(a,b+c-4),a=a.slice(b,b+c),decoder.decode(a),this.m_cmd=decoder.m_out)}};
